#!/bin/sh

cccheck() {
if [ ! -z "$CC" ]; then
cat << EOF > conftest.c
int main(void){return 0;}
EOF
	$CC -o conftest conftest.c >/dev/null 2>&1
	if [ $? -eq 0 ]; then
		./conftest
		if [ $? -eq 0 ]; then
			rm -f conftest conftest.c
			cc="$CC"
			return 0
		else
			echo "could not build working executables"
			echo "Please ensure your C compiler is a native compiler"
			exit 1
		fi
	else
		rm -f conftest conftest.c
	fi
else

for compiler in cc clang gcc; do
cat << EOF > conftest.c
int main(void){return 0;}
EOF

	$compiler -o conftest conftest.c >/dev/null 2>&1
	if [ $? -eq 0 ]; then
		./conftest
		if [ $? -eq 0 ]; then
			rm -f conftest conftest.c
			cc="$compiler"
			return 0
		else
			echo "could not build working executables"
			echo "Please ensure your C compiler is a native compiler"
			exit 1
		fi
	else
		rm -f conftest conftest.c
	fi
done
fi
return 1
}

pledgecheck() {
cat << EOF > conftest.c
#include <unistd.h>
int main(void){pledge(NULL,NULL);return 0;}
EOF
$cc $tflags -o conftest conftest.c >/dev/null 2>&1
if [ $? -eq 0 ] ; then
	rm -f conftest conftest.c
	return 0
else
	rm -f conftest conftest.c
	return 1
fi
}

if [ ! -z "$CFLAGS" ]; then
  cflags="$CFLAGS -DHAVE_CONFIG -Wall -Wextra -g -O2"
else
  cflags="-DHAVE_CONFIG -Wall -Wextra -g -O2"
fi

if [ ! -z "$LDFLAGS" ] ; then
  ldflags="$LDFLAGS "
else
  ldflags=""
fi

if [ ! -z "$PREFIX" ] ; then
  prefix="$PREFIX"
else
  prefix="/usr/local"
fi

mandir="$prefix/man"

prog="sunstat"
static=0

# Options
for opt; do
case "$opt" in
	--prefix=*)
		prefix="$(echo $opt | cut -d '=' -f 2)" ;;
	--mandir=*)
		mandir="$(echo $opt | cut -d '=' -f 2)" ;;
	--disable-static|--enable-static)
		if [ "x$opt" = "x--enable-static" ]; then
			static=1
		fi
	;;
	--help|-h)
		echo "Usage: configure [options]"
		echo ""
		echo "Options:"
		printf "  --help or -h            "
		echo "Display this help message"
		printf "  --prefix=PREFIX         "
		echo "Top level install directory is PREFIX [$prefix]"
		printf "  --mandir=MANDIR         "
		echo "Manual pages are installed to MANDIR [$mandir]"
		printf "  --enable-static         "
		echo "Statically link executables [default=no]"
		exit 0
	;;
	*)
	;;
esac; done

printf "checking for C compiler... "
cccheck
if [ $? -ne 0 ]; then
	echo "not found"
	echo "Please install a C compiler and re-run configure."
	exit 1
else
	echo "$cc"
fi

cat << EOF > config.h
/* This file generated automatically by configure.  */
EOF

printf "checking for pledge... "
pledgecheck
if [ $? -eq 0 ]; then
	echo "#define HAVE_PLEDGE" >> config.h
	echo "yes"
else
	echo "no"
fi

if [ ${static} -ne 0 ] ; then
  ldflags="${ldflags}-static"
fi

printf "creating Makefile... "
cat << EOF > Makefile
# This Makefile automatically generated by configure.
.POSIX:

CC =            $cc
CFLAGS =        $cflags
LDFLAGS =       $ldflags
PREFIX =        $prefix
MANDIR =        $mandir
PROG =          $prog

OBJS =  sunstat.o

all: \${PROG}

\${PROG}: \${OBJS}
	\${CC} \${LDFLAGS} -o \${PROG} \${OBJS} -lm

install:
	install -d \${DESTDIR}\${PREFIX}/bin
	install -s -o root -g bin -m 0755 \${PROG} \${DESTDIR}\${PREFIX}/bin

test:
	echo "No tests"

clean:
	rm -f \${PROG} \${OBJS}

distclean: clean
	rm -f Makefile config.h
EOF
echo "done"
